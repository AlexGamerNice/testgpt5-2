<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2P Chess — Auto Connect with Turns</title>
  <link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <style>
    body{font-family:sans-serif;background:#0f172a;color:#e6eef8;margin:0}
    .wrap{max-width:960px;margin:auto;padding:20px}
    #board{width:520px;margin:auto}
    .controls{text-align:center;margin-top:10px}
    input,button{padding:8px;margin:4px;border-radius:6px;border:none}
    button{background:#0ea5a3;color:white;cursor:pointer}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Peer-to-Peer Chess — Auto Connect (Turn-based)</h1>
  <div id="board"></div>
  <div class="controls">
    <input id="gameId" placeholder="Game code" />
    <button id="hostBtn">Host Game (Play White)</button>
    <button id="joinBtn">Join Game (Play Black)</button>
    <button id="newBtn">New Game</button>
    <button id="undoBtn">Undo</button>
    <button id="flipBtn">Flip Board</button>
  </div>
  <pre id="log"></pre>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://unpkg.com/chess.js@1.0.0-beta.0/dist/chess.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://unpkg.com/simple-signal-client@3.0.0/dist/simple-signal-client.min.js"></script>
<script>
  const board = Chessboard('board', {draggable:true, position:'start', onDrop:onDrop, onSnapEnd:onSnapEnd})
  const game = new Chess()
  const logEl = document.getElementById('log')
  let myColor = 'white' // default for host

  function log(msg){logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight}

  let peer = null
  const socket = io('https://00850ff6-5701-4601-9e81-d2a56919d140-00-3s8ymv4r0l5bq.worf.replit.dev/') // <-- replace with your Replit URL
  const signalClient = new SimpleSignalClient(socket)

  document.getElementById('hostBtn').onclick = async ()=>{
    myColor = 'white'
    board.orientation('white')
    const id = document.getElementById('gameId').value.trim()
    if(!id) return alert('Enter a game code')
    log('Hosting game: '+id)
    signalClient.on('request', async request => {
      peer = request.accept()
      setupPeer()
    })
  }

  document.getElementById('joinBtn').onclick = async ()=>{
    myColor = 'black'
    board.orientation('black')
    const id = document.getElementById('gameId').value.trim()
    if(!id) return alert('Enter a game code')
    log('Joining game: '+id)
    const {peer: p} = await signalClient.connect(id)
    peer = p
    setupPeer()
  }

  function setupPeer(){
    peer.on('connect', ()=>{ log('Connected!') })
    peer.on('data', data => {
      try{
        const msg = JSON.parse(data)
        if(msg.t==='move') applyRemoteMove(msg.m)
        if(msg.t==='state'){ game.load(msg.fen); board.position(game.fen()) }
      }catch(e){ log('Bad data') }
    })
  }

  function onDrop(source, target){
    // Enforce turn
    if((game.turn()==='w' && myColor!=='white') || (game.turn()==='b' && myColor!=='black')){
      return 'snapback'
    }
    const move = game.move({from:source, to:target, promotion:'q'})
    if(move === null) return 'snapback'
    board.position(game.fen())
    send({t:'move', m:move})
  }

  function onSnapEnd(){ board.position(game.fen()) }
  function applyRemoteMove(m){ game.move({from:m.from,to:m.to,promotion:m.promotion||'q'}); board.position(game.fen()) }
  function send(obj){ if(peer && peer.connected) peer.send(JSON.stringify(obj)) }

  document.getElementById('newBtn').onclick = ()=>{ game.reset(); board.start(); send({t:'state', fen:game.fen()}) }
  document.getElementById('undoBtn').onclick = ()=>{ game.undo(); board.position(game.fen()); send({t:'state', fen:game.fen()}) }
  document.getElementById('flipBtn').onclick = ()=> board.flip()
</script>
</body>
</html>
